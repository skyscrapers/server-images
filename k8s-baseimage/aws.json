{
    "variables": {
        "aws_region"            : "eu-west-1",
        "aws_instance_type"     : "t2.medium",
        "root_volume_size"      : "8",
        "root_volume_type"      : "gp2",
        "teleport_version"      : "3.0.1",
        "source_ami"            : "",
        "kubernetes_version"    : "",
        "runc_release_url"      : "https://github.com/rancher/runc-cve/releases/download/CVE-2019-5736-build3/runc-v17.03.2-amd64",
        "runc_release_checksum" : "25d2965a74d33e7bc7e16f6b6fef6a8c93a115d0c1027bdb792b2a57c03f2a74"
    },
    "builders": [{
        "type"                     : "amazon-ebs",
        "region"                   : "{{user `aws_region`}}",
        "instance_type"            : "{{user `aws_instance_type`}}",
        "source_ami"               : "{{user `source_ami`}}",
        "ssh_username"             : "admin",
        "ssh_pty"                  : true,
        "ami_name"                 : "ebs-kubernetes-baseimage-{{user `kubernetes_version`}}-{{isotime \"200601020304\"}}",
        "ami_description"          : "Kubernetes {{user `kubernetes_version`}} base image, includes Teleport version {{user `teleport_version`}} and AWS inspector agent",
        "ami_groups"               : "all",
        "snapshot_groups"          : "all",
        "ami_block_device_mappings": [{
            "device_name"          : "/dev/xvda",
            "volume_size"          : "{{user `root_volume_size`}}",
            "volume_type"          : "{{user `root_volume_type`}}",
            "delete_on_termination": true
        }],
        "run_tags": {
            "project"         : "kubernetes-baseimage",
            "k8s_version"     : "{{user `kubernetes_version`}}",
            "teleport_version": "{{user `teleport_version`}}"
        },
        "tags": {
            "project"         : "kubernetes-baseimage",
            "k8s_version"     : "{{user `kubernetes_version`}}",
            "teleport_version": "{{user `teleport_version`}}"
        }
    }],
    "provisioners": [
        {
            "type"            : "shell",
            "script"          : "scripts/teleport.sh",
            "environment_vars": [
                "TELEPORT_VERSION={{user `teleport_version`}}"
            ]
        },
        {
            "type"  : "shell",
            "script": "scripts/awsinspector.sh"
        },
        {
            "type"  : "shell",
            "script": "scripts/runc.sh",
            "environment_vars": [
                "RUNC_RELEASE_URL={{user `runc_release_url`}}",
                "RUNC_RELEASE_CHECKSUM={{user `runc_release_checksum`}}"
            ]
        }
    ],
    "post-processors": [{
        "type"      : "manifest",
        "output"    : "packer_manifest.json",
        "strip_path": true
    }]
}
